name: Generate new docs

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'ember or ember-data'     
        required: true
      version:
        description: 'The version to build, i.e. 3.20.0'     
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clone ember-jsonapi-docs
        uses: actions/checkout@v2
        with:
          path: ember-jsonapi-docs # This puts all the cloned projects side-by-side, which seems to be what the README suggests and seems less confusing to me when reading the remaining steps

      - name: Clone ember.js
        uses: actions/checkout@v2
        if: ${{ github.event.inputs.project == "ember" }}
        with:
          repository: emberjs/ember.js
          path: ember.js
          ref: v${{ github.event.inputs.version }}

      - name: Clone ember-data
        uses: actions/checkout@v2
        if: ${{ github.event.inputs.project == "ember-data" }}
        with:
          repository: emberjs/data
          path: data
          ref: v${{ github.event.inputs.version }}

      - name: Clone ember-api-docs-data
        run: git clone https://github.com/ember-learn/ember-api-docs-data
      
      - name: Install dependencies
        working-directory: ember-jsonapi-docs
        run: yarn install

      - name: Generate s3-docs
        working-directory: ember-jsonapi-docs
        run: yarn gen --project "${{ github.event.inputs.project }}" --version "${{ github.event.inputs.version }}"

      - name: Generate json-docs
        working-directory: ember-jsonapi-docs
        run: yarn start --project "${{ github.event.inputs.project }}" --version "${{ github.event.inputs.version }}"
  
  pull-request:
    name: Open a pull request in ember-api-docs-data
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git
        run: |
          git config --global user.name "Tomster"
          git config --global user.email "tomster@emberjs.com"
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.1.1
        with:
          ssh-private-key: ${{ secrets.GUIDES_SOURCE_DEPLOY_KEY }}

      - name: Stage changes
        working-directory:  ember-api-docs-data
        run: git add .

      - name: Commit changes
        working-directory:  ember-api-docs-data
        run: git commit -m "${{ github.event.inputs.project }}-{{ github.event.inputs.version }}"

      - name: Push
        working-directory: ember-api-docs-data
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          if git diff --exit-code HEAD~; then
            echo "Nothing to push"
          else
            git push -u origin "${INPUT_PROJECT}-${INPUT_VERSION}"
          fi
